@startuml


set namespaceSeparator ::


entity communication-service::t_message {
  PK id* UUID
  FK tenant_id* UUID
  FK chat_id* UUID
  FK sender_id* UUID
  FK external_id string
  content jsonb
  content_plain text
  type* string
  delivery_status* string
  seen_flag* boolean
  incoming_flag* boolean
  edited_flag* boolean
  deleted_flag* boolean
  source_type* string
  system_flag* boolean
  sent_at timestamp
  +FK dialog_internal_id UUID
  +sender_employee_id UUID
 }

entity communication-service::t_chat {
  PK id* UUID
  FK tenant_id* UUID
  FK account_id* UUID
  external_id string
  name* string
  type* string //personal/group
  custom_name_flag* boolean
  colour_generate_marker* string
  unread_messages_count* int
  last_message_id uuid  
  deleted_flag* boolean
 }

entity communication-service::t_account {
  PK id* UUID
  FK tenant_id* UUID
  FK provider_id* UUID
  FK channel_type_code UUID
  parent_account_id UUID
  external_id string
  name string
  active_flag* boolean
  settings jsonb
  phone string
  email string
  username string
  self_member_id UUID
}

entity communication-service::t_member {
  PK id* UUID
  FK tenant_id* UUID
  FK account_id* UUID
  external_id string
  name* string
  email string
  phone string
  username string
  +client_flag* boolean
 }

entity communication-service::t_provider {
  PK id* UUID   
  code* string
}

entity communication-service::t_channel_type {
  PK code* string //sms/telegram/avito/email/vk/viber/whatsapp/tgbot/etc.
  label* string //СМС/Авито/Telegram/Whatsapp/etc.
  type* string internal/external
}

 entity communication-service::t_chat_member {
  PK id* UUID
  FK member_id* UUID
  FK chat_id* UUID
}
 entity communication-service::t_attachment {
  PK id* UUID
  FK message_id* UUID
  FK tenant_id* UUID
  name* string
  size* double
  internal_content_url string
  provider_content_url string
  file_extension* string
}

entity communication-service::t_dialog #yellow {
 PK id* UUID
 FK tenant_id* UUID
 account_id* string
 account_name string  
 FK chat_id* UUID
 FK wholesale_dialog_id UUID
 externalChatId string
 name* string
 channel* string TBD
 owner string
 last_manager_message_date timestamp
 last_client_message_date timestamp
 client_flag* boolean
 status string
 automation_flag* boolean
 has_attachment_flag* boolean 
 wholesale_created_date* timestamp
 wholesale_complete_date timestamp
 client_answered_flag*  boolean
 manager_answered_flag*  boolean
}

entity wholesale-service::Dialog #yellow {
  PK id* string
  FK communicationDialogId* string
  accountId* string
  accountName string
  chatId* string
  externalChatId string
  name* string
  channel* string
  owner string
  lastManagerMessageDate datetime
  lastClientMessageDate datetime
  clientFlag* boolean
  state STATE
  automationFlag* boolean
  hasAttachmentFlag* boolean
  createdDate* datetime
  completeDate datetime
  clientAnsweredFlag* boolean    
  managerAnsweredFlag* boolean    
    ...
}

entity wholesale-service::Contact {
  PK id* string
  name* string
  phone string
  email string
  ...
}

entity wholesale-service::DialogContact #yellow {
  PK id* string
  FK dialogId* MASTER-DETAIL
  FK contactId* MASTER-DETAIL
  ...
}

entity wholesale-service::Object #87CEFA {
  PK id* string
  name* string
  ...
}

entity wholesale-service::DialogObject #yellow{
  PK id* string
  FK dialogId* MASTER-DETAIL
  FK objectId* MASTER-DETAIL
  ...
}

entity wholesale-service::Employee {
  PK id* string
  name* string
  role* LOOKUP
  status string
  ...
}

entity wholesale-service::DialogTeam #yellow {
  PK id* string
  dialogId* MASTER-DETAIL
  roleInTeam* string
  teamDivision LOOKUP
  teamEmployee LOOKUP
  teamPermission* string  
  teamWorkGroup  LOOKUP
  ...
}

entity wholesale-service::t_lov {
  PK id* uuid
  FK type_code* varchar(255)
  code* varchar(255)
  value* text
  ...
}

entity wholesale-service::ContactMembers #yellow {
  PK id* string
  FK contactId* MASTER-DETAIL
  communicationAccountId* string
  communicationMemberId* string
  ...
}

entity communication-service::t_provider_configuration #ccccff {
  PK id UUID
  FK provider_id* UUID
  provider_label* string
  app_code* string
  app_version* string
  configuration_version* string
  status* string
  endpoints* jsonb
}

entity communication-service::t_tenant_provider_connection #ccccff {
  PK id* UUID
  FK tenant_id* UUID
  FK provider_id* UUID
  FK configuration_id* UUID
  status* string
}

t_message }o-- t_chat : chat_id
t_message --|| t_member: sender_id
t_attachment }o-- t_message: message_id
t_chat }o-- t_account: account_id
t_account --|| t_channel_type: channel_type_code
t_member }o-- t_account: account_id
t_account --|| t_provider: provider_id
t_chat_member }o-- t_chat : chat_id
t_chat_member }o-- t_member: member_id
t_account --o{ t_account:  parent_account_id
Dialog ||.. t_dialog: wholesale_dialog_id
Employee ..o{ t_message: sender_employee_id
Contact ..o{ t_member: contact_id 
t_dialog --o{ t_message: dialog_internal_id
t_chat --o{ t_dialog:chat_id
Dialog --o{ DialogContact: dialogId
Contact --o{ DialogContact: contactId
Dialog --o{ DialogObject: dialogId
Object --o{ DialogObject: objectId
Employee --o{ Dialog: owner
Dialog --o{ DialogTeam: dialogId
DialogTeam --o{ Employee: teamEmployee
t_lov --o{ t_lov: type_code
Dialog --|| t_lov: channel
Dialog ..|| t_dialog: communicationDialogId
ContactMembers }o-- Contact: contactId
t_member .. ContactMembers: communicationMemberId
t_provider_configuration }o-- t_provider: provider_id
t_tenant_provider_connection }o-- t_provider: provider_id
t_tenant_provider_connection }o-- t_provider_configuration: configuration_id

@enduml