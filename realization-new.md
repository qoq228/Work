# Реализация модуля коммуникаций с публичным API для провайдеров

## Приложение провайдера в маркетплейсе
1. Провайдер должен иметь возможность опубликовать свое приложение только с соблюдением следующих факторов:
   1. В настройках доступов приложения поставлена галочка напротив пункта "Коммуникации"
      1. Этот пункт необходимо добавить миграцией БД
   2. В модуль коммуникаций установлена конфигурация провайдера
      1. Применяется разработанное API для установки/обновления/удаления конфигурации провайдера через маркетплейс
   3. Пройдена модерация приложения командой SberCRM
   4. Пройдено тестирование на тестовом стенде командами провайдера и SberCRM
2. При подключении доступа к коммуникациям должен создаваться новый провайдер
   1. Применяется разработанное API для создания/обновления провайдера
3. Конфигурация провайдера должна быть привязана к версии приложения
4. При создании новой версии приложения маркетплейс должен уведомить модуль коммуникаций об этом
   1. Модуль коммуникаций должен привязать конфигурацию предыдущей версии приложения к новой
5. Код провайдера в коммуникациях должен соответствовать системному названию приложения провайдера
6. Провайдер не должен иметь возможность отключать скоуп коммуникаций, если он уже включен (галочка "Провайдер коммуникаций" в настройках приложения)
   1. Провайдер может подключить скоуп коммуникаций в любой версии приложения

## Разделение API системы

Для обеспечения грамотного разделения ответственности и управления доступом, система разделена на три компонента API:

1. **Публичный API для провайдеров** - предоставляет интерфейс для внешних систем-провайдеров для взаимодействия с модулем коммуникаций
2. **API взаимодействия маркетплейса с модулем коммуникаций** - обеспечивает управление провайдерами и конфигурациями тенантов
3. **API маркетплейса для работы с конфигурациями провайдеров** - позволяет управлять конфигурациями провайдеров в маркетплейсе

Такое разделение обеспечивает четкую границу ответственности и независимость в разработке каждого API.

## Конфигурация провайдера
1. Конфигурация провайдера должна быть привязана к версии приложения
2. При подключении скоупа коммуникаций приложению провайдер должен загрузить свою конфигурацию через API маркетплейса
3. При создании новой версии приложения маркетплейс должен уведомить модуль коммуникаций об этом через соответствующий API-эндпоинт
   1. Модуль коммуникаций должен привязать конфигурацию предыдущей версии приложения к новой
4. Провайдер должен повышать версию конфигурации при каждом ее обновлении согласно семантическому версионированию
5. При первой загрузке или обновлении конфигурации, загруженная версия автоматически должна становиться активной. Все предыдущие версии должны быть в неактивном статусе
6. Только разработчик своего приложения должен иметь возможность устанавливать и обновлять конфигурацию провайдера, как и само приложение

### Структура конфигурации провайдера

Конфигурация провайдера включает следующие элементы:

1. **Основная информация**:
   - `appCode` - системное имя провайдера
   - `appVersion` - версия приложения провайдера
   - `configurationVersion` - версия конфигурации
   - `providerLabel` - отображаемое название провайдера

2. **Эндпоинты провайдера**, с которыми будет взаимодействовать модуль коммуникаций:
   
   **Обязательные эндпоинты**:
   - `sendMessage` - Отправка сообщения
   - `updateMessageContent` - Обновление текста сообщения
   - `updateMessageStatus` - Обновление статуса сообщения
   - `markChatRead` - Прочтение сообщений в чате
   - `disconnect` - Отключение приложения
   - `getChannels` - Запрос списка каналов

   **Необязательные эндпоинты**:
   - `setWebhook` - Установка вебхука
   - `deleteWebhook` - Удаление вебхука
   - `getMessageHistory` - Загрузка истории сообщений
   - `bulkMessages` - Пакетная отправка сообщений

3. **Конфигурация аутентификации**:
   - Тип аутентификации (на данный момент поддерживается только API_KEY)
   - Настройки заголовков или других параметров аутентификации

## Конфигурация провайдера для тенанта
1. Модуль коммуникаций должен хранить связку Тенант ↔ Версия конфигурации
2. При установке приложения тенанту он должен подключаться к активной конфигурации, которая привязана к установленной версии приложения
   1. Используется эндпоинт `/internal/v1/tenant-configurations` для создания связки
3. Пользователь должен переходить на новую версию конфигурации только при обновлении версии приложения
   1. Это делается вручную в маркетплейсе
   2. При обновлении версии приложения маркетплейс должен уведомить модуль коммуникаций о переходе пользователя на новую версию приложения. Модуль коммуникаций должен обновить связку Тенант ↔ Версия конфигурации

## Публичный API модуля коммуникаций

### Основные принципы
1. Разработан публичный API на стороне модуля коммуникаций SberCRM, которым смогут пользоваться провайдеры
2. Методы публичного API должны быть доступны только с токеном клиента, который тот получил в ЛК провайдера
3. Система поддерживает аутентификацию клиента через JWT токен
   1. Поддержка Basic Auth и OAuth 2.0 будет реализована в следующих релизах

### Основные группы эндпоинтов публичного API

Публичное API разделено на следующие группы эндпоинтов:

#### 1. Управление каналами
- **POST /channels** - Подключение нового канала
  - При получении запроса на подключение канала от провайдера модуль коммуникаций должен создать/активировать аккаунт для этого канала
- **DELETE /channels/{channelId}** - Отключение канала
  - При получении запроса на отключение канала от провайдера модуль коммуникаций должен деактивировать аккаунт для этого канала

#### 2. Управление чатами
- **POST /chats** - Создание нового чата
- **PATCH /chats/{chatId}** - Обновление информации о чате
- **POST /chats/{chatId}/seen** - Отметка чата как прочитанного
  - При получении запроса на прочтение чата модуль коммуникаций должен перевести все непрочитанные сообщения в чате в статус прочитанных (seen_flag = true)

#### 3. Управление сообщениями
- **POST /messages** - Создание нового сообщения
  - При получении нового сообщения модуль коммуникаций должен найти чат, id которого передается внутри сообщения в объекте chat
  - Если такого чата нет - его необходимо создать вместе со всеми участниками (вся информация о чате передается внутри сообщения в объекте chat)
  - Модуль коммуникаций пока не поддерживает форматирование текста - текст будет сохранен со всеми спецсимволами
- **PATCH /messages/{messageId}** - Обновление текста сообщения
  - При получении запроса на обновление текста сообщения модуль коммуникаций должен только заменить текст сообщения на новый без изменения других атрибутов сообщения
- **POST /messages/{messageId}/status** - Обновление статуса сообщения
  - При получении запроса на обновление статуса сообщения модуль коммуникаций должен изменить статус сообщения на тот, который был передан в запросе

#### 4. Вебхуки
- **POST /webhooks** - Установка вебхука для получения уведомлений
- **GET /webhooks** - Получение информации о текущем вебхуке
- **DELETE /webhooks** - Удаление вебхука

#### 5. Массовые операции
- **POST /bulk/messages** - Пакетная отправка сообщений
  - Позволяет отправлять до 100 сообщений в одном запросе
  - Возвращает информацию о статусе обработки каждого сообщения

### Активация и деактивация токена

1. По событию активации токена клиента в настройках интеграции с провайдером модуль коммуникаций должен провести процедуру создания/активации аккаунтов по провайдеру
   1. Если в конфигурации провайдера указан эндпоинт для запроса истории сообщений модуль коммуникаций должен провести процедуру первичной синхронизации чатов

2. По событию деактивации токена клиента в настройках интеграции с провайдером модуль коммуникаций должен передать этот факт провайдеру и перестать обращаться к эндпоинтам провайдера для этого тенанта

3. По событию отключения приложения в маркетплейсе модуль коммуникаций должен передать этот факт провайдеру и перестать обращаться к эндпоинтам провайдера для этого тенанта
   1. При отключении приложения в маркетплейсе должна быть проведена процедура деактивации аккаунтов (основного и дочерних) этого провайдера у тенанта

4. Реализовать иконку-заглушку для каналов код которых не поддерживается модулем коммуникаций SberCRM
   1. Каналы с нестандартным кодом будут сохранены, но отображаться будет общая иконка-заглушка

## API для взаимодействия маркетплейса с модулем коммуникаций

Этот API предназначен для взаимодействия между маркетплейсом и модулем коммуникаций и включает следующие основные эндпоинты:

1. **Управление провайдерами**:
   - **POST /internal/v1/providers** - Регистрация нового провайдера

2. **Управление конфигурациями тенантов**:
   - **POST /internal/v1/tenant-configurations** - Создание связки тенант-конфигурация
   - **PUT /internal/v1/tenant-configurations** - Обновление связки тенант-конфигурация
   - **DELETE /internal/v1/tenant-configurations** - Удаление связки тенант-конфигурация

## API маркетплейса для работы с конфигурациями провайдеров

Этот API предназначен для управления конфигурациями провайдеров в рамках маркетплейса:

1. **Управление конфигурациями провайдеров**:
   - **POST /internal/v1/marketplace/provider-configurations** - Создание конфигурации провайдера
   - **GET /internal/v1/marketplace/provider-configurations** - Получение конфигурации провайдера
   - **PUT /internal/v1/marketplace/provider-configurations** - Обновление конфигурации провайдера

## Документация на портале разработчика
1. На портале разработчика SberCRM должна быть опубликована следующая документация:
   1. Описание модуля коммуникаций SberCRM, его основные сущности и принципы работы
   2. Подробный гайд по интеграции для провайдеров от установки приложения до вывода конфига в пром)
      1. Необходимо описать список названий каналов, которые поддерживаются модулем коммуникаций (например Telegram ↔ telegram)
   3. Публичный API в формате OpenAPI